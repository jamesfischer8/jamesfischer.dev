---
layout: base
title: The Garden
---

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

<style>
  /* Mobile-first approach: default styles for mobile */

  /* Base styles */
  body {
    background: linear-gradient(135deg, #2c2416 0%, #3d3426 50%, #2c2416 100%);
    color: #d4c4a0;
    font-family: 'Crimson Text', 'Times New Roman', serif;
    min-height: 100vh;
  }

  /* Page title */
  .page-title {
    text-align: center;
    color: #88b04b;
    font-size: 28px;
    margin-bottom: 15px;
    font-weight: 700;
    letter-spacing: 2px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
  }

  /* Utility classes */
  .hidden {
    display: none !important;
  }

  /* Test palette */
  #test-palette {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #2a2a2a;
    border: 2px solid #666;
    border-radius: 3px;
    padding: 10px;
    width: 180px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
    z-index: 1000;
    font-size: 12px;
    font-family: 'Courier New', monospace;
    transition: transform 0.3s ease;
  }

  #test-palette.collapsed {
    transform: translateX(100%);
  }

  #test-palette h4 {
    margin: 0 0 8px 0;
    color: #fff;
    font-size: 12px;
    text-align: center;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Courier New', monospace;
  }

  #test-palette button {
    width: 100%;
    margin: 2px 0;
    font-size: 10px;
    padding: 3px 4px;
    background: #333;
    color: #ccc;
    border: 1px solid #555;
    border-radius: 2px;
    font-family: 'Courier New', monospace;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #test-palette button:hover {
    background: #444;
    color: #fff;
    border-color: #777;
  }

  #test-palette .test-section {
    margin-bottom: 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid #555;
  }

  #test-palette .test-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  #test-palette-toggle {
    position: absolute;
    left: -27px;
    top: 50%;
    transform: translateY(-50%);
    background: #2a2a2a;
    border: 2px solid #666;
    border-right: none;
    border-radius: 3px 0 0 3px;
    padding: 6px 2px;
    cursor: pointer;
    color: #ccc;
    font-size: 14px;
    width: 27px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: none;
  }

  #test-palette-toggle:hover {
    background: #444;
    color: #fff;
    border-color: #777;
  }

  #test-palette.collapsed #test-palette-toggle {
    border-radius: 6px 0 0 6px;
  }
  /* Game container - mobile first */
  #game {
    margin-top: 20px;
    padding: 25px;
    background: #1a1611;
    border: 3px solid #4a3f2a;
    border-radius: 8px;
    margin-left: auto;
    margin-right: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), inset 0 1px 3px rgba(74, 63, 42, 0.3);
  }
  /* Sidebar - mobile first */
  #sidebar {
    background: #252019;
    border: 2px solid #5a4d35;
    border-radius: 6px;
    padding: 18px;
    height: fit-content;
    box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4);
  }
  #main-area {
    flex: 1;
    text-align: center;
  }
  /* Stats - mobile first */
  #stats {
    margin-bottom: 20px;
    font-size: 18px;
    text-align: center;
  }
  #inventory {
    margin-bottom: 10px;
  }
  #inventory h3 {
    margin: 0 0 12px 0;
    color: #c49b61;
    font-size: 18px;
    font-weight: 600;
    letter-spacing: 1px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }
  button {
    font-size: 16px;
    padding: 10px 18px;
    margin: 4px;
    border: 2px solid #6b5639;
    border-radius: 4px;
    background: linear-gradient(145deg, #3a2f1e, #2d241a);
    color: #c49b61;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Crimson Text', serif;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(196, 155, 97, 0.1);
    -webkit-user-select: none;
    user-select: none;
  }
  button span {
    pointer-events: none;
    display: block;
  }
  button:disabled {
    border-color: #3a322a;
    color: #4a4137;
    cursor: not-allowed;
    background: #1f1a15;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
  }
  button:hover:not(:disabled) {
    background: linear-gradient(145deg, #4a3d28, #3d3220);
    border-color: #8a7352;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(196, 155, 97, 0.2);
  }
  #pots-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin: 10px 0;
    transition: gap 0.6s ease;
  }
  #pots-container.compact-mode {
    /* No changes needed for compact mode */
  }
  #pots-container.minimal-mode {
    /* No container changes - inherit from compact-mode */
  }
  #pots-container.compact-mode .pot {
    min-width: calc(50% - 7.5px);
    max-width: calc(50% - 7.5px);
    padding: 12px;
  }
  #pots-container.compact-mode .pot h3 {
    margin-bottom: 8px;
  }
  #pots-container.compact-mode .pot progress {
    margin: 8px 4px 4px 4px;
  }
  #pots-container.compact-mode .pot .pot-actions {
    display: none;
  }
  #pots-container.auto-planter .pot .plant-btn {
    display: none;
  }
  #pots-container.auto-harvester .pot .harvest-btn {
    display: none;
  }
  #pots-container.minimal-mode .pot {
    border-width: 0px;
    border-color: rgba(90, 77, 53, 0);
    background: linear-gradient(135deg, rgba(42, 35, 24, 0), rgba(31, 28, 20, 0));
    box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    padding-top: 0;
    padding-bottom: 0;
  }
  #pots-container.minimal-mode .pot h3 {
    opacity: 0;
    height: 0;
    margin: 0;
  }
  /* Pot - mobile first */
  .pot {
    border: 2px solid #5a4d35;
    border-radius: 6px;
    padding: 18px;
    background: linear-gradient(135deg, #2a2318, #1f1c14);
    min-width: calc(50% - 7.5px);
    max-width: calc(50% - 7.5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(90, 77, 53, 0.2);
    transition: min-width 0.6s ease, padding 0.6s ease, border-width 0.6s ease, border-color 0.6s ease, background 0.6s ease, box-shadow 0.6s ease;
  }
  .pot h3 {
    margin: 0 0 12px 0;
    font-size: 17px;
    color: #b8956f;
    text-align: center;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
    line-height: 24px;
    transition: margin 0.6s ease, opacity 0.3s ease, height 0.6s ease;
  }
  .pot progress {
    width: calc(100% - 8px);
    margin: 12px 4px;
    height: 8px;
    border-radius: 4px;
    background: #1a1611;
    border: 1px solid #4a3f2a;
    box-sizing: border-box;
    transition: margin 0.6s ease;
  }
  .pot progress::-webkit-progress-bar {
    background: #1a1611;
    border-radius: 4px;
  }
  .pot progress::-webkit-progress-value {
    background: linear-gradient(90deg, #4a6b2a, #5a7b35);
    border-radius: 4px;
  }
  .pot.harvesting progress::-webkit-progress-value {
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .pot button {
    font-size: 14px;
    padding: 6px 12px;
  }
  .pot-actions {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
    transition: opacity 0.6s ease, height 0.6s ease;
  }
  .pot-actions button {
    flex: 1;
  }
  .pot-actions:empty {
    display: none;
  }
  .plant-visual {
    font-size: 16px;
    opacity: 0.8;
    margin-left: 6px;
    display: inline-block;
    width: 18px;
    text-align: center;
  }
  #controls {
    border-top: 1px solid #88b04b;
    padding-top: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  #controls button {
    flex: 1 1 calc(50% - 3px);
    min-width: 0;
    margin: 0;
    font-size: 14px;
    padding: 8px 6px;
  }
  /* Desktop styles */
  @media (min-width: 769px) {
    #game {
      max-width: 1000px;
      flex-direction: row;
      gap: 20px;
      margin-top: 50px;
    }
    #sidebar {
      flex: 0 0 250px;
    }
    #stats {
      text-align: left;
    }
    .pot {
      min-width: 220px;
      max-width: none;
    }
    #pots-container.compact-mode .pot {
      min-width: 160px;
      max-width: none;
    }
    .pot button {
      font-size: 14px;
      padding: 6px 12px;
    }
    .pot-actions {
      flex-direction: row;
      gap: 8px;
    }
    #pots-container {
      margin: 20px 0;
    }
    .page-title {
      margin-bottom: 30px;
    }
    #inventory {
      margin-bottom: 20px;
    }
    #controls {
      display: block;
      gap: unset;
    }
    #controls button {
      display: block;
      width: 100%;
      margin: 5px 0;
      font-size: 16px;
      padding: 10px 18px;
      flex: unset;
      min-width: unset;
    }
  }
</style>

<h1 class="page-title">The Garden</h1>
<!-- Test Palette -->
<div id="test-palette" class="hidden">
  <div id="test-palette-toggle" title="Toggle Test Palette">âš™</div>
  <h4>Test Tools</h4>

  <div class="test-section">
    <button id="test-free-mode">Toggle Free Mode</button>
    <button id="test-add-money">Add $10,000</button>
    <button id="test-add-seeds">Add 100 Seeds</button>
  </div>

  <div class="test-section">
    <button id="test-speed-growth">Toggle Fast Growth</button>
    <button id="test-toggle-minimal">Toggle Minimal</button>
    <button id="test-add-pots">Add 10 Pots</button>
  </div>

  <div class="test-section">
    <button id="test-unlock-all">Unlock All Upgrades</button>
    <button id="test-reset-game">Reset Game</button>
  </div>
</div>

<div id="game">
  <div id="sidebar">
    <div id="stats">
      Money: <span id="money">$0</span> <br>
      Seeds: <span id="seeds">1</span> <br>
      Pots: <span id="pot-count">1</span> <br>
      <span id="seeds-per-sec-line" class="hidden">Seeds/sec: <span id="seed-buyer-count">0</span> <br></span>
    </div>

    <div id="inventory">
      <h3>Shop</h3>
      <div id="controls">
        <button id="buy-seed" disabled>Buy seed ($1)</button>
        <button id="buy-10-seeds" disabled class="hidden">Buy 10 seeds ($10)</button>
        <button id="buy-pot" disabled>Buy pot ($100)</button>
        <button id="buy-auto-planter" disabled>Auto-Planter ($0)</button>
        <button id="buy-auto-harvester" disabled>Auto-Harvester ($0)</button>
        <button id="buy-auto-seeder" disabled class="hidden">Seed Buyer ($0)</button>
      </div>
    </div>
  </div>

  <div id="main-area">
    <div id="pots-container"></div>
  </div>
</div>

<script>
  (function() {
    // ===== GAME CONFIGURATION =====
    var CONFIG = {
      GROWTH_DURATION: 15000,
      SALE_PRICE: 50,
      SEED_COST: 1,
      POT_COST: 100,
      AUTO_HARVESTER_COST: 1000,
      AUTO_PLANTER_COST: 200,
      AUTO_SEEDER_BASE_COST: 10000,
      SEED_BUYER_SCALING: 1.1,
      POT_SCALING_FACTOR: 1.1,
      POT_SCALING_THRESHOLD: 6,
      BULK_SEED_UNLOCK: 10
    };

    var moneyEl = document.getElementById('money');
    var seedsEl = document.getElementById('seeds');
    var potCountEl = document.getElementById('pot-count');
    var seedBuyerCountEl = document.getElementById('seed-buyer-count');
    var seedsPerSecLineEl = document.getElementById('seeds-per-sec-line');
    var buySeedBtn = document.getElementById('buy-seed');
    var buyPotBtn = document.getElementById('buy-pot');
    var buyAutoHarvesterBtn = document.getElementById('buy-auto-harvester');
    var buyAutoPlanterBtn = document.getElementById('buy-auto-planter');
    var buyAutoSeederBtn = document.getElementById('buy-auto-seeder');
    var buy10SeedsBtn = document.getElementById('buy-10-seeds');
    var testPalette = document.getElementById('test-palette');
    var potsContainer = document.getElementById('pots-container');

    // Game state
    var seeds = 1;
    var money = 0;
    var pots = [
      {
        id: 0,
        planted: false,
        growth: 0,
        plantTime: null
      }
    ];

    // Check for test mode (for palette visibility only)
    var urlParams = new URLSearchParams(window.location.search);
    var isTestMode = urlParams.has('test');
    var hasAutoHarvester = false;
    var hasAutoPlanter = false;
    var seedBuyerCount = 0;
    var seedBuyerRemainder = 0.0; // Fractional remainder for seed buying
    var lastSeedBuyerUpdate = Date.now();
    var currentSeedBuyerRate = 0; // Current effective rate after slowdown
    var forceMinimal = false; // Manual toggle override
    var testFreeMode = false; // Test mode for free purchases
    var testFastGrowth = false; // Test mode for fast growth
    var individualSeedsPurchased = 0; // Track individual seed purchases

    // UI state tracking
    var uiState = {
      money: -1, // Initialize to -1 to force first update
      seeds: -1,
      potCount: -1,
      seedBuyerCount: -1,
      currentSeedBuyerRate: -1,
      seedBtnText: '',
      potBtnText: '',
      autoHarvesterBtnText: '',
      autoPlanterBtnText: '',
      autoSeederBtnText: '',
      buy10SeedsBtnText: '',
      seedBtnDisabled: null,
      potBtnDisabled: null,
      autoHarvesterBtnDisabled: null,
      autoPlanterBtnDisabled: null,
      autoSeederBtnDisabled: null,
      buy10SeedsBtnDisabled: null,
      pots: {} // Track pot UI states
    };

    function getNextSeedBuyerCost() {
      return Math.ceil(CONFIG.AUTO_SEEDER_BASE_COST * Math.pow(CONFIG.SEED_BUYER_SCALING, seedBuyerCount));
    }

    function getCurrentPotCost() {
      var scalingFactor = Math.floor(pots.length / CONFIG.POT_SCALING_THRESHOLD);
      return Math.floor(CONFIG.POT_COST * Math.pow(CONFIG.POT_SCALING_FACTOR, scalingFactor));
    }

    function hasGrowingPlants() {
      return pots.some(function(pot) {
        return pot.planted; // Either growing or ready to harvest
      });
    }

    function updatePotCompactness() {
      var shouldBeCompact = hasAutoPlanter && hasAutoHarvester;
      var shouldBeMinimal = (shouldBeCompact && pots.length > 18) || forceMinimal;

      // Update container classes
      if (shouldBeMinimal) {
        potsContainer.classList.add('compact-mode', 'minimal-mode');
      } else if (shouldBeCompact) {
        potsContainer.classList.add('compact-mode');
        potsContainer.classList.remove('minimal-mode');
      } else {
        potsContainer.classList.remove('compact-mode', 'minimal-mode');
      }

      // Update individual automation classes
      if (hasAutoPlanter) {
        potsContainer.classList.add('auto-planter');
      } else {
        potsContainer.classList.remove('auto-planter');
      }

      if (hasAutoHarvester) {
        potsContainer.classList.add('auto-harvester');
      } else {
        potsContainer.classList.remove('auto-harvester');
      }
    }

    function updatePotButtons() {
      // Button visibility is now handled by CSS via compact-mode class
      updatePotCompactness();
    }

    function createPotElement(pot) {
      var potDiv = document.createElement('div');
      potDiv.className = 'pot';

      var plantButton = hasAutoPlanter ? '' : `<button class="plant-btn" data-pot="${pot.id}">Plant seed</button>`;
      var harvestButton = hasAutoHarvester ? '' : `<button class="harvest-btn" data-pot="${pot.id}" disabled>Harvest ($${formatMoney(CONFIG.SALE_PRICE)})</button>`;

      potDiv.innerHTML = `
        <h3>Pot ${pot.id + 1} <span class="plant-visual" data-pot="${pot.id}"></span></h3>
        <progress class="growth-bar" max="100" value="0"></progress>
        <div class="pot-actions">
          ${plantButton}
          ${harvestButton}
        </div>
      `;
      return potDiv;
    }

    function renderPots() {
      potsContainer.innerHTML = '';
      // Reset pot UI state since we're re-rendering with new DOM elements
      uiState.pots = {};

      pots.forEach(function(pot) {
        potsContainer.appendChild(createPotElement(pot));
      });

      // Add event listeners to new buttons
      document.querySelectorAll('.plant-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var potId = parseInt(this.dataset.pot);
          plantSeed(potId);
        });
      });

      document.querySelectorAll('.harvest-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var potId = parseInt(this.dataset.pot);
          harvestFlower(potId);
        });
      });

      // Trigger transitions after DOM is ready
      setTimeout(function() {
        updatePotCompactness();
      }, 10);
    }

    function addNewPot(pot) {
      var newPotElement = createPotElement(pot);
      potsContainer.appendChild(newPotElement);

      // Add event listeners to new buttons
      var plantBtn = newPotElement.querySelector('.plant-btn');
      if (plantBtn) {
        plantBtn.addEventListener('click', function() {
          var potId = parseInt(this.dataset.pot);
          plantSeed(potId);
        });
      }

      var harvestBtn = newPotElement.querySelector('.harvest-btn');
      if (harvestBtn) {
        harvestBtn.addEventListener('click', function() {
          var potId = parseInt(this.dataset.pot);
          harvestFlower(potId);
        });
      }

      // No transition needed - container classes handle styling
    }


    function plantSeed(potId) {
      var pot = pots[potId];
      if (seeds > 0 && !pot.planted) {
        seeds--;
        pot.growth = 0;
        pot.planted = true;
        pot.plantTime = Date.now();
        update();
      }
    }

    function harvestFlower(potId) {
      var pot = pots[potId];
      if (pot.growth >= 100 && pot.planted) {
        // Add harvesting class for bouncy animation
        var potElement = document.querySelector(`[data-pot="${potId}"]`).closest('.pot');
        potElement.classList.add('harvesting');

        pot.planted = false;
        pot.growth = 0;
        money += CONFIG.SALE_PRICE;
        update();
        updateControls();

        // Remove harvesting class after animation completes
        setTimeout(function() {
          potElement.classList.remove('harvesting');
        }, 500);
      }
    }

    // Format numbers with commas
    function formatMoney(amount) {
      return amount.toLocaleString();
    }

    // Update functions that only modify DOM when values change
    function updateMoney(value) {
      if (uiState.money !== value) {
        uiState.money = value;
        moneyEl.textContent = value < 0 ? '-$' + formatMoney(Math.abs(value)) : '$' + formatMoney(value);
      }
    }

    function updateSeeds(value) {
      if (uiState.seeds !== value) {
        uiState.seeds = value;
        seedsEl.textContent = value;
      }
    }

    function updatePotCount(value) {
      if (uiState.potCount !== value) {
        uiState.potCount = value;
        potCountEl.textContent = value;
      }
    }

    function updateSeedBuyerCount(value, currentRate) {
      var rateChanged = uiState.currentSeedBuyerRate !== currentRate;
      if (uiState.seedBuyerCount !== value || rateChanged) {
        uiState.seedBuyerCount = value;
        uiState.currentSeedBuyerRate = currentRate;

        if (value > 0) {
          // Show both base count and current effective rate
          var rateText = currentRate !== undefined ? currentRate.toFixed(1) : value;
          seedBuyerCountEl.textContent = rateText;
          seedsPerSecLineEl.classList.remove('hidden');
        } else {
          seedsPerSecLineEl.classList.add('hidden');
        }
      }
    }

    function updateButtonState(button, text, disabled, stateKey) {
      var textKey = stateKey + 'Text';
      var disabledKey = stateKey + 'Disabled';

      if (uiState[textKey] !== text) {
        uiState[textKey] = text;
        button.innerHTML = text;
      }

      if (uiState[disabledKey] !== disabled) {
        uiState[disabledKey] = disabled;
        button.disabled = disabled;
      }
    }

    function update() {
      updateMoney(money);
      updateSeeds(seeds);
      updatePotCount(pots.length);
      updateSeedBuyerCount(seedBuyerCount, currentSeedBuyerRate); // Show effective rate

      // Update each pot's display
      pots.forEach(function(pot) {
        var plantBtn = document.querySelector(`[data-pot="${pot.id}"].plant-btn`);
        var harvestBtn = document.querySelector(`[data-pot="${pot.id}"].harvest-btn`);
        var plantVisual = document.querySelector(`.plant-visual[data-pot="${pot.id}"]`);
        var growthBar = plantVisual ? plantVisual.closest('.pot').querySelector('.growth-bar') : null;

        if (growthBar && plantVisual) {
          // Initialize pot state if needed
          if (!uiState.pots[pot.id]) {
            uiState.pots[pot.id] = {
              plantBtnDisabled: null,
              harvestBtnDisabled: null,
              growth: -1,
              visual: ''
            };
          }

          var potState = uiState.pots[pot.id];

          // Update plant button state (if button exists)
          if (plantBtn) {
            var plantBtnShouldBeDisabled = pot.planted || seeds <= 0;
            if (potState.plantBtnDisabled !== plantBtnShouldBeDisabled) {
              potState.plantBtnDisabled = plantBtnShouldBeDisabled;
              plantBtn.disabled = plantBtnShouldBeDisabled;
            }
          }

          // Update harvest button state (if button exists)
          if (harvestBtn) {
            var harvestBtnShouldBeDisabled = pot.growth < 100;
            if (potState.harvestBtnDisabled !== harvestBtnShouldBeDisabled) {
              potState.harvestBtnDisabled = harvestBtnShouldBeDisabled;
              harvestBtn.disabled = harvestBtnShouldBeDisabled;
            }
          }

          // Update growth bar
          if (potState.growth !== pot.growth) {
            potState.growth = pot.growth;
            growthBar.value = pot.growth;
          }

          // Update visual state
          var newVisual;
          if (!pot.planted) {
            newVisual = ''; // Empty pot
          } else if (pot.growth >= 90) {
            newVisual = 'ðŸŒ¹'; // Nearly ready to harvest
          } else if (pot.growth >= 33.33) {
            newVisual = 'ðŸŒ¿'; // Growing nicely
          } else {
            newVisual = 'ðŸŒ±'; // Just planted
          }

          if (potState.visual !== newVisual) {
            potState.visual = newVisual;
            plantVisual.textContent = newVisual;
          }
        }
      });
    }

    function updateControls() {
      updateButtonState(
        buySeedBtn,
        '<span>Buy seed ($' + formatMoney(CONFIG.SEED_COST) + ')</span>',
        !testFreeMode && money < CONFIG.SEED_COST && !(money === 0 && seeds === 0 && !hasGrowingPlants()),
        'seedBtn'
      );

      // Show "buy 10 seeds" button after buying threshold individual seeds
      if (individualSeedsPurchased >= CONFIG.BULK_SEED_UNLOCK) {
        buy10SeedsBtn.classList.remove('hidden');
        var buy10Cost = CONFIG.SEED_COST * 10;
        updateButtonState(
          buy10SeedsBtn,
          '<span>Buy 10 seeds ($' + formatMoney(buy10Cost) + ')</span>',
          !testFreeMode && money < buy10Cost,
          'buy10SeedsBtn'
        );
      } else {
        buy10SeedsBtn.classList.add('hidden');
      }

      updateButtonState(
        buyPotBtn,
        '<span>Buy pot ($' + formatMoney(getCurrentPotCost()) + ')</span>',
        !testFreeMode && money < getCurrentPotCost(),
        'potBtn'
      );

      updateButtonState(
        buyAutoHarvesterBtn,
        hasAutoHarvester ? '<span>Auto-Harvester (Owned)</span>' : '<span>Auto-Harvester ($' + formatMoney(CONFIG.AUTO_HARVESTER_COST) + ')</span>',
        hasAutoHarvester || (!testFreeMode && money < CONFIG.AUTO_HARVESTER_COST),
        'autoHarvesterBtn'
      );

      updateButtonState(
        buyAutoPlanterBtn,
        hasAutoPlanter ? '<span>Auto-Planter (Owned)</span>' : '<span>Auto-Planter ($' + formatMoney(CONFIG.AUTO_PLANTER_COST) + ')</span>',
        hasAutoPlanter || (!testFreeMode && money < CONFIG.AUTO_PLANTER_COST),
        'autoPlanterBtn'
      );

      // Show seed buyer only after auto-planter is purchased
      if (hasAutoPlanter) {
        buyAutoSeederBtn.classList.remove('hidden');
        var nextCost = getNextSeedBuyerCost();
        var buttonText = seedBuyerCount > 0
          ? '<span>Seed Buyer #' + (seedBuyerCount + 1) + ' ($' + formatMoney(nextCost) + ')</span>'
          : '<span>Seed Buyer ($' + formatMoney(nextCost) + ')</span>';
        updateButtonState(
          buyAutoSeederBtn,
          buttonText,
          !testFreeMode && money < nextCost,
          'autoSeederBtn'
        );
      } else {
        buyAutoSeederBtn.classList.add('hidden');
      }
    }


    // Auto-grow progress over time
    setInterval(function() {
      pots.forEach(function(pot) {
        if (pot.planted && pot.growth < 100) {
          var effectiveGrowthDuration = testFastGrowth ? CONFIG.GROWTH_DURATION / 10 : CONFIG.GROWTH_DURATION;
          pot.growth = (Date.now() - pot.plantTime) / effectiveGrowthDuration * 100;
          if (pot.growth > 100) pot.growth = 100;
        }

        // Auto-harvest when ready
        if (hasAutoHarvester && pot.growth >= 100 && pot.planted) {
          // Give a brief moment to see the final flower emoji before harvesting
          setTimeout(function() {
            harvestFlower(pot.id);
          }, 200);
        }

      });
      update();
    }, 16);

    // Update button states less frequently to avoid interfering with clicks
    setInterval(function() {
      updateControls();
    }, 100);

    // Auto-planter runs less frequently to avoid consuming seeds too aggressively
    setInterval(function() {
      if (hasAutoPlanter) {
        pots.some(function(pot) {
          // Check if pot is currently being harvested
          var potElement = document.querySelector(`[data-pot="${pot.id}"]`);
          var isHarvesting = potElement && potElement.closest('.pot').classList.contains('harvesting');

          // Auto-plant if empty, we have seeds, and pot isn't mid-harvest animation
          if (!pot.planted && seeds > 0 && !isHarvesting) {
            seeds--;
            pot.growth = 0;
            pot.planted = true;
            pot.plantTime = Date.now();
	    return true;
	  } else {
	    return false;
	  }
        });
        update();
      }
    }, 20);

    // Auto-seeders run smoothly, accumulating fractional progress
    setInterval(function() {
      if (seedBuyerCount > 0) {
        var now = Date.now();
        var deltaTime = (now - lastSeedBuyerUpdate) / 1000; // Convert to seconds
        lastSeedBuyerUpdate = now;

        // Calculate slowdown multiplier based on seed stockpile
        // Normal rate for seeds < 100, 1% slower for each seed over 99
        var slowdownMultiplier = seeds < 100 ? 1 : 1 / (1 + (seeds - 99) * 0.01);

        // Update current effective rate
        currentSeedBuyerRate = seedBuyerCount * slowdownMultiplier;

        // Add fractional seeds to remainder (seedBuyerCount seeds per second, adjusted by slowdown)
        seedBuyerRemainder += seedBuyerCount * deltaTime * slowdownMultiplier;

        // Buy whole seeds from the accumulated remainder
        var wholeSeedsToBuy = Math.floor(seedBuyerRemainder);
        if (wholeSeedsToBuy > 0) {
          var totalCost = wholeSeedsToBuy * CONFIG.SEED_COST;
          if (money >= totalCost) {
            // Can afford all whole seeds
            money -= totalCost;
            seeds += wholeSeedsToBuy;
            seedBuyerRemainder -= wholeSeedsToBuy; // Keep the fractional part
            update();
          } else if (money >= CONFIG.SEED_COST) {
            // Can afford some seeds
            var affordableSeeds = Math.floor(money / CONFIG.SEED_COST);
            money -= affordableSeeds * CONFIG.SEED_COST;
            seeds += affordableSeeds;
            seedBuyerRemainder -= affordableSeeds; // Keep the fractional part
            update();
          }
        }
      }
    }, 16);

    function attachDirectListeners() {
      buySeedBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (!this.disabled && (testFreeMode || money >= CONFIG.SEED_COST || (money === 0 && seeds === 0 && !hasGrowingPlants()))) {
          if (!testFreeMode) money -= CONFIG.SEED_COST;
          seeds++;
          individualSeedsPurchased++; // Track individual seed purchases
          update();
        }
      });

      buy10SeedsBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        var buy10Cost = CONFIG.SEED_COST * 10;
        if (!this.disabled && (testFreeMode || money >= buy10Cost)) {
          if (!testFreeMode) money -= buy10Cost;
          seeds += 10;
          update();
        }
      });

      buyPotBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        var currentPotCost = getCurrentPotCost();
        if (!this.disabled && (testFreeMode || money >= currentPotCost)) {
          if (!testFreeMode) money -= currentPotCost;
          var newPot = {
            id: pots.length,
            planted: false,
            growth: 0,
            plantTime: null
          };
          pots.push(newPot);
          addNewPot(newPot);
          updatePotCompactness();
          update();
        }
      });

      buyAutoHarvesterBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (!this.disabled && (testFreeMode || money >= CONFIG.AUTO_HARVESTER_COST) && !hasAutoHarvester) {
          if (!testFreeMode) money -= CONFIG.AUTO_HARVESTER_COST;
          hasAutoHarvester = true;
          updatePotButtons(); // Update button visibility and animate compactness
          update();
        }
      });

      buyAutoPlanterBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (!this.disabled && (testFreeMode || money >= CONFIG.AUTO_PLANTER_COST) && !hasAutoPlanter) {
          if (!testFreeMode) money -= CONFIG.AUTO_PLANTER_COST;
          hasAutoPlanter = true;
          updatePotButtons(); // Update button visibility and animate compactness
          update();
        }
      });

      buyAutoSeederBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        var nextCost = getNextSeedBuyerCost();
        if (!this.disabled && (testFreeMode || money >= nextCost)) {
          if (!testFreeMode) money -= nextCost;
          seedBuyerCount++;
          // Reset timer and remainder when first seed buyer is purchased to prevent backfill
          if (seedBuyerCount === 1) {
            lastSeedBuyerUpdate = Date.now();
            seedBuyerRemainder = 0.0;
          }
          update();
        }
      });

      // Test palette event listeners
      document.getElementById('test-free-mode').addEventListener('click', function(e) {
        e.stopPropagation();
        testFreeMode = !testFreeMode;
        this.textContent = testFreeMode ? 'Disable Free Mode' : 'Toggle Free Mode';
        updateControls();
      });

      document.getElementById('test-add-money').addEventListener('click', function(e) {
        e.stopPropagation();
        money += 10000;
        update();
      });

      document.getElementById('test-add-seeds').addEventListener('click', function(e) {
        e.stopPropagation();
        seeds += 100;
        update();
      });

      document.getElementById('test-speed-growth').addEventListener('click', function(e) {
        e.stopPropagation();
        testFastGrowth = !testFastGrowth;
        this.textContent = testFastGrowth ? 'Disable Fast Growth' : 'Toggle Fast Growth';
      });

      document.getElementById('test-toggle-minimal').addEventListener('click', function(e) {
        e.stopPropagation();
        forceMinimal = !forceMinimal;
        updatePotCompactness();
        this.textContent = forceMinimal ? 'Disable Minimal' : 'Toggle Minimal';
      });

      document.getElementById('test-add-pots').addEventListener('click', function(e) {
        e.stopPropagation();
        for (var i = 0; i < 10; i++) {
          var newPot = {
            id: pots.length,
            planted: false,
            growth: 0,
            plantTime: null
          };
          pots.push(newPot);
          addNewPot(newPot);
        }
        updatePotCompactness();
        update();
      });

      document.getElementById('test-unlock-all').addEventListener('click', function(e) {
        e.stopPropagation();
        hasAutoPlanter = true;
        hasAutoHarvester = true;
        seedBuyerCount = 5;
        updatePotButtons();
        update();
      });

      document.getElementById('test-reset-game').addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm('Reset all game progress?')) {
          location.reload();
        }
      });

      // Test palette collapse/expand functionality
      document.getElementById('test-palette-toggle').addEventListener('click', function(e) {
        e.stopPropagation();
        testPalette.classList.toggle('collapsed');
      });
    }

    // Show test palette only in test mode
    if (isTestMode) {
      testPalette.classList.remove('hidden');
      // Start collapsed on mobile screens
      if (window.innerWidth <= 768) {
        testPalette.classList.add('collapsed');
      }
    }

    // Attach direct listeners after a delay
    setTimeout(attachDirectListeners, 100);

    // Call updateControls initially to handle the buy 10 seeds button visibility
    setTimeout(function() {
      updateControls();
    }, 150);

    // Initial render
    renderPots();
    update();
    updateControls();
  })();
</script>
